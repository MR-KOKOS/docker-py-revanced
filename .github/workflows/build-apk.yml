name: Build & Release
env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  HAVE_TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID != '' }}
on:
  workflow_call:
    inputs:
      GITHUB_UPLOAD:
        description: "Upload to GitHub"
        required: false
        type: boolean
        default: true
      TELEGRAM_NO_ROOT_UPLOAD:
        description: "Upload Non Rooted APKs to Telegram"
        required: false
        type: boolean
        default: false
      TELEGRAM_ROOT_UPLOAD:
        description: "Upload Magisk Module from nikhilbadyal/revanced-magisk-module to Telegram"
        required: false
        type: boolean
        default: false
      APPRISE_NOTIFY:
        description: "Use Apprise to Notify"
        required: false
        type: boolean
        default: false
      CLEANUP:
        description: "Clear GitHub(Useful if Telegram upload is enabled)"
        required: false
        type: boolean
        default: false
      COMMIT_CHANGELOG:
        description: "Update Changelog"
        type: boolean
        required: false
        default: true
      DEBUG_ENABLED:
        type: boolean
        description: 'Run the build with tmate debugging enabled.'
        required: false
        default: false
      PREFERRED_PATCH_APPS:
        description: "Apps to be patched. Overrides any env set"
        required: false
        type: string
  workflow_dispatch:
    inputs:
      GITHUB_UPLOAD:
        description: "Upload to GitHub"
        required: false
        type: boolean
        default: true
      TELEGRAM_NO_ROOT_UPLOAD:
        description: "Upload Non Rooted APKs to Telegram"
        required: false
        type: boolean
        default: false
      TELEGRAM_ROOT_UPLOAD:
        description: "Upload Magisk Module from nikhilbadyal/revanced-magisk-module to Telegram"
        required: false
        type: boolean
        default: false
      APPRISE_NOTIFY:
        description: "Use Apprise to Notify"
        required: false
        type: boolean
        default: false
      CLEANUP:
        description: "Clear GitHub(Useful if Telegram upload is enabled)"
        required: false
        type: boolean
        default: false
      COMMIT_CHANGELOG:
        description: "Update Changelog"
        type: boolean
        required: false
        default: true
      DEBUG_ENABLED:
        type: boolean
        description: 'Run the build with tmate debugging enabled.'
        required: false
        default: false
      PREFERRED_PATCH_APPS:
        description: "Apps to be patched. Overrides any env set"
        required: false
        type: string

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
jobs:
  build-apk:
    uses: ./.github/workflows/build-artifact.yml
    with:
      COMMIT_CHANGELOG: ${{ inputs.COMMIT_CHANGELOG }}
      DEBUG_ENABLED: ${{ inputs.DEBUG_ENABLED }}
      PREFERRED_PATCH_APPS: ${{ inputs.PREFERRED_PATCH_APPS }}
    secrets:
      ENVS: ${{ secrets.ENVS }}
      DOCKER_PY_REVANCED_SECRETS: ${{ secrets.DOCKER_PY_REVANCED_SECRETS }}
      REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}

  upload-to-github:
    name: GitHub Upload
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build-apk
    if: inputs.GITHUB_UPLOAD

    steps:
      - name: Download Already Built APKs
        uses: actions/download-artifact@main
        with:
          name: Built-APKs
      - name: Get Date
        id: get-date
        run: |
          echo "date=$(TZ='Asia/Kolkata' date +"%Y.%m.%d-%H.%M.%S")" >> $GITHUB_OUTPUT

      - name: Delete Older Releases
        uses: nikhilbadyal/ghaction-rm-releases@v0.0.5
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_PATTERN: "Build*"

      - name: Delete existing assets on latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPS: ${{ inputs.PREFERRED_PATCH_APPS }}
        run: |
          set -e
          echo "Fetching release info for tag 'latest'..."
          release_response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/latest")
          
          release_id=$(echo "$release_response" | jq -r '.id // empty')
          if [ -z "$release_id" ] || [ "$release_id" = "null" ]; then
            echo "No existing 'latest' release found; skipping cleanup"
            exit 0
          fi
          
          echo "Found release ID: $release_id"
          
          # Fetch all assets for this release
          assets_response=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/$release_id/assets")
          
          # Determine which apps we're actually uploading (based on existing APK files)
          # This prevents deleting assets for apps that failed to build
          built_apps=""
          for apk in apks/*-output.apk; do
            if [ -f "$apk" ]; then
              # Extract app name from filename: Re{APP_NAME}-Version...
              app_name=$(basename "$apk" | sed 's/^Re//' | sed 's/-Version.*//')
              if [ -n "$built_apps" ]; then
                built_apps="${built_apps},${app_name}"
              else
                built_apps="${app_name}"
              fi
            fi
          done
          
          echo "APKs found for apps: $built_apps"
          
          # Use built apps for filtering if available, otherwise fall back to APPS input
          if [ -n "$built_apps" ]; then
            echo "Only deleting assets for successfully built apps"
            pattern=$(echo "$built_apps" | tr ',' '|')
            asset_ids=$(echo "$assets_response" | jq -r ".[] | select(.name | test(\"^Re(${pattern})\")) | .id")
          elif [ -n "$APPS" ]; then
            echo "Filtering assets for apps: $APPS"
            pattern=$(echo "$APPS" | tr ',' '|')
            asset_ids=$(echo "$assets_response" | jq -r ".[] | select(.name | test(\"^Re(${pattern})\")) | .id")
          else
            echo "No app filter; will delete all APK assets"
            asset_ids=$(echo "$assets_response" | jq -r '.[] | select(.name | endswith("-output.apk")) | .id')
          fi
          
          # Delete each matching asset
          deleted_count=0
          for asset_id in $asset_ids; do
            echo "Deleting asset ID: $asset_id"
            curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/releases/assets/$asset_id" || true
            deleted_count=$((deleted_count + 1))
          done
          
          echo "Deleted $deleted_count asset(s)"

      - name: Upload Build Artifact
        uses: ncipollo/release-action@main
        with:
          artifacts: "apks/*-output.apk,updates.json,changelog.json,changelog.md"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: latest
          name: "Build-${{ steps.get-date.outputs.date }}"
          body: |
            ## ReVanced Build

            **Last Built:** ${{ steps.get-date.outputs.date }}

            This release contains the latest patched APKs. See changelog files for details.
          allowUpdates: true
          replacesArtifacts: true
          artifactErrorsFailBuild: true

      - name: Sleep for 10 seconds
        run: |
          sleep 10

  upload-to-telegram:
    needs: [ upload-to-github ]
    uses: nikhilbadyal/ghactions/.github/workflows/telegram-uploader.yml@main
    if: inputs.TELEGRAM_NO_ROOT_UPLOAD
    secrets:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_STICKER_ID: ${{ secrets.TELEGRAM_STICKER_ID }}
      MESSAGE: ${{ secrets.MESSAGE_NON_ROOT }}

  upload-to-telegram-root:
    needs: [ upload-to-telegram ]
    uses: nikhilbadyal/ghactions/.github/workflows/telegram-uploader.yml@main
    if: inputs.TELEGRAM_ROOT_UPLOAD
    secrets:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      DOWNLOAD_GITHUB_REPOSITORY: ${{ secrets.ROOT_DOWNLOAD_GITHUB_REPOSITORY }}
      MESSAGE: ${{ secrets.MESSAGE_ROOT }}

  apprise-notifier:
    needs: build-apk
    name: Apprise Notifier
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: inputs.APPRISE_NOTIFY

    steps:
      - name: Download Already Built APKs
        uses: actions/download-artifact@main
        with:
          name: Built-APKs

      - name: Find all built apks
        id: ff
        run: |
          apk_list=""
          for filename in $(find . -name "*-output.apk" -type f); do
            apk_list="$apk_list,$filename"
          done
          apk_list=${apk_list:1}
          echo "apks=$apk_list" >> "$GITHUB_OUTPUT"
          is_present=$([ -n "${{ secrets.APPRISE_URL }}" ] && echo true || echo false );
          echo "has_apprise_url=$is_present"  >> $GITHUB_OUTPUT
      - name: Print files
        run: echo "${{ steps.ff.outputs.apks }} ${{ steps.ff.outputs.has_apprise_url }}"

      - name: Upload to Telegram
        uses: nikhilbadyal/ghaction-apprise@main
        with:
          APPRISE_URL: ${{ secrets.APPRISE_URL }}
          APPRISE_NOTIFICATION_BODY: ${{ secrets.APPRISE_NOTIFICATION_BODY }}
          APPRISE_NOTIFICATION_TITLE: ${{ secrets.APPRISE_NOTIFICATION_TITLE }}
          APPRISE_ATTACHMENTS: ${{ steps.ff.outputs.apks }}

  cleanup:
    name: GitHub Cleanup
    if: inputs.CLEANUP
    needs: [ upload-to-telegram ]
    uses: ./.github/workflows/github-cleanup.yml
    secrets:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
